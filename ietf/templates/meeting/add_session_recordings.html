{% extends "base.html" %}
{# Copyright The IETF Trust 2015, All Rights Reserved #}
{% load origin static django_bootstrap5 %}
{% block title %}Add I-Ds to {{ session.meeting }} : {{ session.group.acronym }}{% endblock %}
{% block pagehead %}{{ form.media.css }}{% endblock %}
{% block content %}
    {% origin %}
    <h1>
        Add Recordings to  {{ session.meeting }}
        {% if session_number %}: Session {{ session_number }}{% endif %}
        <br>
        <small class="text-body-secondary">{{ session.group.acronym }}
            {% if session.name %}: {{ session.name }}{% endif %}
        </small>
    </h1>
    {% comment %} TODO: put the session name here or calculate the number at the meeting {% endcomment %}
    {% if session.is_material_submission_cutoff %}
        <div class="alert alert-warning my-3">
            The deadline for submission corrections has passed. This may affect published proceedings.
        </div>
    {% endif %}
    <h2 class="mt-5">Recordings already linked to this session</h2>
    {% if already_linked %}
        <form method="post" id="delete_recordings_form">
            {% csrf_token %}
            <table class="table table-sm table-striped tablesorter">
                <thead>
                    <tr>
                        <th scope="col" data-sort="num">Revision</th>
                        <th scope="col" data-sort="document">Document</th>
                        <th scope="col">Delete</th>
                    </tr>
                </thead>
                <tbody>
                        {% for sp in already_linked %}
                            <tr>
                                <td>
                                    {% if sp.rev %}
                                        -{{ sp.rev }}
                                    {% else %}
                                        (current)
                                    {% endif %}
                                </td>
                                <td><a href="{{ sp.external_url }}">{{ sp.title }}</a></td>
                                <td><button type="submit" aria-label="Delete {{ sp.title }}" class="btn btn-danger" name="delete" value="{{ sp.pk }}">Delete</button></td>
                            </tr>
                        {% endfor %}
                </tbody>
            </table>
        </form>
    {% else %}
        <table class="table table-sm table-striped">
            <thead>
                <tr>
                    <th scope="col" data-sort="num">Revision</th>
                    <th scope="col" data-sort="document">Document</th>
                    <th scope="col">Delete</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td colspan="3" class="text-center font-italic">(none)</td>
                </tr>
            </tbody>
        </table>
    {% endif %}
    <dialog id="delete_confirm_dialog">
        <p>Really delete the link to <a href="#" id="delete_confirm_link">(default)</a>?</p>
        <form method="post" class="d-flex justify-content-between">
            {% csrf_token %}
            <button class="btn btn-secondary" type="button" id="delete_confirm_cancel">Cancel</button>
            <button class="btn btn-danger" type="submit" name="delete" id="delete_confirm_submit">Delete</button>
        </form>
    </dialog>
    <h2 class="mt-5">Add additional recordings to this session</h2>
    <form method="post">
        {% csrf_token %}
        {% bootstrap_form form %}
        <button class="btn btn-{% if session.is_material_submission_cutoff %}warning{% else %}primary{% endif %}"
                type="submit">
            Add recording
        </button>
        <a class="btn btn-secondary float-end"
           href="{% url 'ietf.meeting.views.session_details' num=session.meeting.number acronym=session.group.acronym %}">
            Back
        </a>
    </form>
{% endblock %}
{% block js %}
    {{ form.media.js }}

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const form = document.getElementById('delete_recordings_form')
        const dialog = document.getElementById('delete_confirm_dialog')
        const dialog_link = document.getElementById('delete_confirm_link')
        const dialog_submit = document.getElementById('delete_confirm_submit')
        const dialog_cancel = document.getElementById('delete_confirm_cancel')

        dialog.style.maxWidth = '30vw';

        form.addEventListener('submit', (e) => {
            e.preventDefault()
            dialog_submit.value = e.submitter.value
            const recording_link = e.submitter.closest('tr').querySelector('a')
            dialog_link.setAttribute('href', recording_link.getAttribute('href'))
            dialog_link.textContent = recording_link.textContent
            dialog.showModal()
        })

        dialog_cancel.addEventListener('click', (e) => {
            e.preventDefault()
            dialog.close()
        })

        document.addEventListener('keydown', (e) => {
            if (dialog.open && e.key === 'Escape') {
                dialog.close()
            }
        })
    })
    </script>
    
{% endblock %}